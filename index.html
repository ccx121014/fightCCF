<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FightCCF - 编程战斗游戏</title>
  <!-- Tailwind CSS v3 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide 图标库 -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.544.0/dist/umd/lucide.min.js"></script>
  <!-- 配置 Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#0ea5e9',
            secondary: '#10b981',
            accent: '#f97316',
            dark: '#0f172a',
            light: '#f8fafc'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          animation: {
            'float': 'float 3s ease-in-out infinite',
            'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'glow': 'glow 2s ease-in-out infinite alternate',
            'slide-in': 'slideIn 0.5s ease-out forwards',
            'fade-in': 'fadeIn 0.5s ease-out forwards',
            'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            },
            glow: {
              '0%': { boxShadow: '0 0 5px rgba(14, 165, 233, 0.5)' },
              '100%': { boxShadow: '0 0 20px rgba(14, 165, 233, 0.8), 0 0 30px rgba(14, 165, 233, 0.6)' },
            },
            slideIn: {
              '0%': { transform: 'translateX(-100%)', opacity: '0' },
              '100%': { transform: 'translateX(0)', opacity: '1' },
            },
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            shake: {
              '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
              '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
              '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
              '40%, 60%': { transform: 'translate3d(4px, 0, 0)' },
            }
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .text-shadow-glow {
        text-shadow: 0 0 10px rgba(14, 165, 233, 0.7);
      }
      .bg-grid {
        background-image: 
          linear-gradient(rgba(14, 165, 233, 0.1) 1px, transparent 1px),
          linear-gradient(90deg, rgba(14, 165, 233, 0.1) 1px, transparent 1px);
        background-size: 20px 20px;
      }
      .glass {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .computer-hover {
        transition: all 0.3s ease;
      }
      .computer-hover:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 10px 25px -5px rgba(14, 165, 233, 0.4);
      }
      .locked-computer {
        filter: grayscale(0.8);
        opacity: 0.7;
      }
      .character-card {
        transition: all 0.3s ease;
      }
      .character-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px -5px rgba(16, 185, 129, 0.4);
      }
      .character-locked {
        filter: grayscale(1);
        opacity: 0.5;
      }
      .matrix-bg {
        background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1IiBoZWlnaHQ9IjUiPgo8cmVjdCB3aWR0aD0iNSIgaGVpZ2h0PSI1IiBmaWxsPSIjMDAwIj48L3JlY3Q+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiMyMjIiPjwvcmVjdD4KPC9zdmc+');
      }
      .code-rain {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
      }
      .code-char {
        position: absolute;
        color: rgba(16, 185, 129, 0.5);
        font-family: monospace;
        font-size: 14px;
        animation: fall linear infinite;
      }
      @keyframes fall {
        0% {
          transform: translateY(-100%);
          opacity: 1;
        }
        100% {
          transform: translateY(100vh);
          opacity: 0;
        }
      }
      .cursor-blink {
        animation: blink 1s step-end infinite;
      }
      @keyframes blink {
        from, to { opacity: 1; }
        50% { opacity: 0; }
      }
      .pixel-art {
        image-rendering: pixelated;
        image-rendering: crisp-edges;
      }
    }
  </style>
</head>
<body class="bg-dark text-light min-h-screen overflow-x-hidden">
  <!-- 代码雨背景 -->
  <div id="codeRain" class="code-rain"></div>

  <!-- 登录/注册页面 -->
  <div id="authPage" class="min-h-screen flex items-center justify-center p-4 relative z-10">
    <div class="glass rounded-xl p-8 w-full max-w-md shadow-xl animate-fade-in">
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-primary mb-2 text-shadow-glow">FightCCF</h1>
        <p class="text-gray-300">编程战斗游戏 - 解锁你的编程潜能</p>
      </div>
      
      <div class="flex mb-6">
        <button id="showLoginBtn" class="flex-1 py-2 px-4 bg-primary text-white rounded-l-lg focus:outline-none transition-all hover:bg-primary/90">
          登录
        </button>
        <button id="showRegisterBtn" class="flex-1 py-2 px-4 bg-gray-700 text-white rounded-r-lg focus:outline-none transition-all hover:bg-gray-600">
          创建账号
        </button>
      </div>
      
      <!-- 登录表单 -->
      <form id="loginForm" class="space-y-4">
        <div>
          <label for="loginKey" class="block text-sm font-medium text-gray-300 mb-1">秘钥</label>
          <div class="relative">
            <input type="text" id="loginKey" class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="输入你的秘钥...">
            <button type="button" id="pasteKeyBtn" class="absolute right-2 top-2 text-gray-400 hover:text-white">
              <i data-lucide="clipboard-paste"></i>
            </button>
          </div>
        </div>
        <button type="submit" class="w-full py-3 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-all focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-gray-800">
          登录
        </button>
      </form>
      
      <!-- 注册表单 -->
      <form id="registerForm" class="space-y-4 hidden">
        <div>
          <label for="username" class="block text-sm font-medium text-gray-300 mb-1">用户名</label>
          <input type="text" id="username" class="w-full px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="输入你的用户名...">
        </div>
        <button type="submit" class="w-full py-3 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-all focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-gray-800">
          创建账号
        </button>
      </form>
      
      <div class="mt-6 text-center text-sm text-gray-400">
        <p>通过创建账号或登录，你同意我们的<a href="#" class="text-primary hover:underline">服务条款</a></p>
      </div>
    </div>
  </div>

  <!-- 主页 -->
  <div id="homePage" class="min-h-screen p-4 md:p-8 hidden">
    <!-- 顶部信息栏 -->
    <header class="glass rounded-xl p-4 mb-6 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <h1 class="text-2xl font-bold text-primary">FightCCF</h1>
      </div>
      
      <div class="flex items-center space-x-4">
        <div class="hidden md:flex items-center space-x-2 bg-gray-800/50 rounded-lg px-3 py-1">
          <span class="text-sm text-gray-400">秘钥:</span>
          <div class="relative">
            <span id="userKeyDisplay" class="text-sm font-mono truncate max-w-[200px] md:max-w-[300px]">加载中...</span>
            <button id="copyKeyBtn" class="ml-2 text-gray-400 hover:text-white">
              <i data-lucide="copy"></i>
            </button>
          </div>
        </div>
        
        <div class="flex items-center space-x-2">
          <span id="usernameDisplay" class="font-medium">加载中...</span>
          <div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center">
            <i data-lucide="user"></i>
          </div>
        </div>
        
        <button id="logoutBtn" class="text-gray-400 hover:text-white">
          <i data-lucide="log-out"></i>
        </button>
      </div>
    </header>
    
    <!-- 移动端秘钥显示 -->
    <div class="md:hidden glass rounded-xl p-3 mb-6">
      <div class="flex items-center justify-between">
        <span class="text-sm text-gray-400">秘钥:</span>
        <div class="flex items-center">
          <span id="userKeyDisplayMobile" class="text-xs font-mono truncate max-w-[180px]">加载中...</span>
          <button id="copyKeyBtnMobile" class="ml-2 text-gray-400 hover:text-white">
            <i data-lucide="copy" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    </div>
    
    <!-- 主要内容区域 -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
      <!-- 左侧角色选择 -->
      <div class="md:col-span-1">
        <div class="glass rounded-xl p-4 h-full">
          <h2 class="text-xl font-bold mb-4 flex items-center">
            <i data-lucide="users" class="mr-2"></i>角色
          </h2>
          
          <div id="charactersContainer" class="space-y-3">
            <!-- 角色卡片将通过JS动态生成 -->
            <div class="animate-pulse text-center text-gray-400 py-4">
              加载角色中...
            </div>
          </div>
        </div>
      </div>
      
      <!-- 右侧关卡选择 -->
      <div class="md:col-span-3">
        <div class="glass rounded-xl p-4 h-full">
          <h2 class="text-xl font-bold mb-6 flex items-center">
            <i data-lucide="cpu" class="mr-2"></i>关卡选择
          </h2>
          
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="levelsContainer">
            <!-- 关卡计算机将通过JS动态生成 -->
            <div class="animate-pulse text-center text-gray-400 py-4 col-span-full">
              加载关卡中...
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 角色详情模态框 -->
  <div id="characterModal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden">
    <div class="glass rounded-xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto animate-fade-in">
      <div class="flex justify-between items-center mb-4">
        <h2 id="modalCharacterName" class="text-2xl font-bold">角色名称</h2>
        <button id="closeCharacterModal" class="text-gray-400 hover:text-white">
          <i data-lucide="x"></i>
        </button>
      </div>
      
      <div class="flex items-center mb-6">
        <div id="modalCharacterImage" class="w-24 h-24 rounded-lg overflow-hidden mr-4 pixel-art">
          <!-- 角色图片将通过JS设置 -->
        </div>
        <div>
          <div class="text-sm text-gray-400">解锁关卡</div>
          <div id="modalCharacterLevel" class="font-medium">CSP-J</div>
        </div>
      </div>
      
      <div class="mb-6">
        <h3 class="text-lg font-semibold mb-2">技能</h3>
        <div id="modalCharacterSkills" class="space-y-3">
          <!-- 技能列表将通过JS生成 -->
        </div>
      </div>
      
      <div>
        <h3 class="text-lg font-semibold mb-2">背景故事</h3>
        <p id="modalCharacterBio" class="text-gray-300">
          角色背景故事将通过JS设置...
        </p>
      </div>
    </div>
  </div>

  <!-- 未开发提示模态框 -->
  <div id="notDevelopedModal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden">
    <div class="glass rounded-xl p-6 max-w-sm w-full text-center animate-fade-in">
      <div class="w-16 h-16 mx-auto mb-4 text-yellow-500">
        <i data-lucide="alert-triangle" class="w-full h-full"></i>
      </div>
      <h3 class="text-xl font-bold mb-2">功能未开发</h3>
      <p class="text-gray-300 mb-6">该关卡正在开发中，敬请期待！</p>
      <button id="closeNotDevelopedModal" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all">
        确定
      </button>
    </div>
  </div>

  <!-- 复制成功提示 -->
  <div id="copySuccessToast" class="fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg transform translate-y-16 opacity-0 transition-all duration-300 z-50">
    <div class="flex items-center">
      <i data-lucide="check-circle" class="mr-2"></i>
      <span>复制成功！</span>
    </div>
  </div>

  <script>
    // 初始化Lucide图标
    lucide.createIcons();
    
    // 全局游戏状态
    const gameState = {
      currentUser: null,
      levels: [
        { id: 'cspj', name: 'CSP-J', locked: false, characterId: 'red' },
        { id: 'csps', name: 'CSP-S', locked: true, characterId: 'blue' },
        { id: 'noip', name: 'NOIP', locked: true, characterId: 'green' },
        { id: 'province', name: '省选', locked: true, characterId: 'yellow' },
        { id: 'noi', name: 'NOI', locked: true, characterId: 'purple' },
        { id: 'chairman', name: 'CCF主席', locked: true, characterId: 'white' }
      ],
      characters: [
        {
          id: 'red',
          name: '红码客',
          level: 'CSP-J',
          image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/5e05ac10d60a469abed61ef4de8e2d8e~tplv-a9rns2rl98-image.image?rcl=2025121216030395467CD91F7E894B454B&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1768118643&x-signature=l2p0H%2FBzkKa%2BmVNkwQ4SVPx9en4%3D',
          skills: [
            { name: '快速排序', description: '对敌人造成100点伤害，并降低其速度30%，持续2秒。' },
            { name: '二分查找', description: '精准打击敌人弱点，造成150点伤害。' }
          ],
          bio: '红码客是编程世界的新手，但凭借着对算法的热爱和快速学习能力，他正在不断成长。他擅长基础算法，特别是排序和查找算法。'
        },
        {
          id: 'blue',
          name: '蓝程序',
          level: 'CSP-S',
          image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/7f63c65075ee4b85a3b4a2adbc9f1de7~tplv-a9rns2rl98-image.image?rcl=2025121216030395467CD91F7E894B454B&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1768118658&x-signature=ehkU6tO3dk8prr3fy2rKF4SiGOI%3D',
          skills: [
            { name: '深度优先搜索', description: '对敌人及其周围单位造成80点伤害。' },
            { name: '动态规划', description: '恢复自身100点生命值，并提高防御力20%，持续3秒。' }
          ],
          bio: '蓝程序是一位经验丰富的程序员，擅长解决复杂的算法问题。他对图论和动态规划有深入研究，能够在困境中找到最优解。'
        },
        {
          id: 'green',
          name: '绿算法',
          level: 'NOIP',
          image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/cb8f60eeca2e4bb080a448bdd3859670~tplv-a9rns2rl98-image.image?rcl=2025121216030395467CD91F7E894B454B&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1768118658&x-signature=diZVzgrGdYKwJwvgzp2BQ55kM8s%3D',
          skills: [
            { name: '网络流', description: '对敌人造成持续伤害，每秒50点，持续4秒。' },
            { name: '线段树', description: '提高自身攻击力50%，持续3秒，并对敌人造成200点伤害。' }
          ],
          bio: '绿算法是算法竞赛的常客，他精通高级数据结构和算法。他能够将复杂的问题分解为可管理的部分，并迅速找到解决方案。'
        },
        {
          id: 'yellow',
          name: '黄数据',
          level: '省选',
          image: 'https://p9-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/e982c4281d8a4df498ec56c2ced6b4cc~tplv-a9rns2rl98-image.image?rcl=2025121216030395467CD91F7E894B454B&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1768118659&x-signature=G6NngIdcBB%2B9TF%2FRU%2Fqg2rfhDOc%3D',
          skills: [
            { name: '矩阵快速幂', description: '对敌人造成300点伤害，并使其眩晕1秒。' },
            { name: '博弈论', description: '预测敌人行动，闪避下一次攻击，并反击造成150点伤害。' }
          ],
          bio: '黄数据是一位数据科学家，擅长处理大规模数据和复杂的数学模型。他的编程风格严谨而高效，能够在有限的时间内解决高难度问题。'
        },
        {
          id: 'purple',
          name: '紫OIer',
          level: 'NOI',
          image: 'https://p26-doubao-search-sign.byteimg.com/labis/100c46e2b771aad4725468174f1fc9ba~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1781078622&x-signature=ifKzKCl4zo150r1S4uOqSzyOIxY%3D',
          skills: [
            { name: '人工智能', description: '召唤AI助手，对敌人造成400点伤害，并降低其攻击力50%，持续5秒。' },
            { name: '分布式计算', description: '分裂成多个分身，每个分身对敌人造成100点伤害。' }
          ],
          bio: '紫OIer是一位国际级的算法竞赛选手，他的编程能力已经达到了大师级别。他擅长创新算法和优化现有解决方案，是编程世界的传奇人物。'
        },
        {
          id: 'white',
          name: '白主席',
          level: 'CCF主席',
          image: 'https://p26-doubao-search-sign.byteimg.com/labis/08bc24ea7b41c645c60b54ea5aa83e20~tplv-be4g95zd3a-image.jpeg?rk3s=542c0f93&x-expires=1781078622&x-signature=1B2Ql8tH%2BMrwHWRkawPTE1bcXtI%3D',
          skills: [
            { name: '政策制定', description: '改变战场规则，使所有敌人受到200点伤害，并降低其所有属性30%，持续10秒。' },
            { name: '终极评测', description: '对敌人进行最终评测，造成666点伤害，如果敌人生命值低于30%，则直接击败敌人。' }
          ],
          bio: '白主席是CCF的最高领导者，拥有无可匹敌的编程能力和智慧。他制定了编程世界的规则，并确保所有程序员都能在公平的环境中竞争和成长。'
        }
      ]
    };
    
    // DOM元素
    const authPage = document.getElementById('authPage');
    const homePage = document.getElementById('homePage');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const showLoginBtn = document.getElementById('showLoginBtn');
    const showRegisterBtn = document.getElementById('showRegisterBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const usernameDisplay = document.getElementById('usernameDisplay');
    const userKeyDisplay = document.getElementById('userKeyDisplay');
    const userKeyDisplayMobile = document.getElementById('userKeyDisplayMobile');
    const copyKeyBtn = document.getElementById('copyKeyBtn');
    const copyKeyBtnMobile = document.getElementById('copyKeyBtnMobile');
    const copySuccessToast = document.getElementById('copySuccessToast');
    const charactersContainer = document.getElementById('charactersContainer');
    const levelsContainer = document.getElementById('levelsContainer');
    const characterModal = document.getElementById('characterModal');
    const closeCharacterModal = document.getElementById('closeCharacterModal');
    const notDevelopedModal = document.getElementById('notDevelopedModal');
    const closeNotDevelopedModal = document.getElementById('closeNotDevelopedModal');
    const pasteKeyBtn = document.getElementById('pasteKeyBtn');
    
    // 初始化代码雨效果
    function initCodeRain() {
      const codeRain = document.getElementById('codeRain');
      const characters = '01アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲン';
      const columns = Math.floor(window.innerWidth / 20);
      
      for (let i = 0; i < columns; i++) {
        const column = document.createElement('div');
        column.style.left = `${i * 20}px`;
        column.style.width = '20px';
        column.style.position = 'absolute';
        column.style.height = '100%';
        
        // 创建多个字符
        const charCount = Math.floor(Math.random() * 10) + 5;
        for (let j = 0; j < charCount; j++) {
          const char = document.createElement('div');
          char.className = 'code-char';
          char.textContent = characters[Math.floor(Math.random() * characters.length)];
          char.style.left = '0';
          char.style.top = `-${j * 30}px`;
          char.style.animationDuration = `${Math.random() * 3 + 2}s`;
          char.style.animationDelay = `${Math.random() * 2}s`;
          column.appendChild(char);
        }
        
        codeRain.appendChild(column);
      }
    }
    
    // 生成用户秘钥
    function generateUserKey(username) {
      // 简单的加密逻辑，实际应用中应该使用更安全的加密方法
      const timestamp = Date.now();
      const levelProgress = '010000'; // 二进制表示关卡进度，第一位为1表示已解锁
      const baseString = `${username}|${timestamp}|${levelProgress}`;
      // 使用Base64编码并添加一些混淆
      let key = btoa(baseString)
        .replace(/=/g, '')
        .split('')
        .reverse()
        .join('');
      // 添加一些随机字符
      const randomChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      for (let i = 0; i < 5; i++) {
        const position = Math.floor(Math.random() * key.length);
        const randomChar = randomChars[Math.floor(Math.random() * randomChars.length)];
        key = key.slice(0, position) + randomChar + key.slice(position);
      }
      return key;
    }
    
    // 解析用户秘钥
    function parseUserKey(key) {
      try {
        // 移除混淆字符
        let cleanKey = '';
        const base64Chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
        for (let char of key) {
          if (base64Chars.includes(char)) {
            cleanKey += char;
          }
        }
        // 还原并解码
        const reversedKey = cleanKey.split('').reverse().join('');
        const paddedKey = reversedKey + '='.repeat((4 - reversedKey.length % 4) % 4);
        const decodedString = atob(paddedKey);
        const [username, timestamp, levelProgress] = decodedString.split('|');
        
        // 验证时间戳，防止过期秘钥（可选）
        const now = Date.now();
        const keyAge = now - parseInt(timestamp);
        const maxAge = 365 * 24 * 60 * 60 * 1000; // 1年
        
        if (keyAge > maxAge) {
          throw new Error('秘钥已过期');
        }
        
        return {
          username,
          timestamp,
          levelProgress
        };
      } catch (error) {
        console.error('解析秘钥失败:', error);
        return null;
      }
    }
    
    // 更新关卡解锁状态
    function updateLevelLocks(levelProgress) {
      for (let i = 0; i < gameState.levels.length; i++) {
        gameState.levels[i].locked = levelProgress[i] !== '1';
      }
    }
    
    // 显示登录表单
    function showLoginForm() {
      loginForm.classList.remove('hidden');
      registerForm.classList.add('hidden');
      showLoginBtn.classList.remove('bg-gray-700');
      showLoginBtn.classList.add('bg-primary');
      showRegisterBtn.classList.remove('bg-primary');
      showRegisterBtn.classList.add('bg-gray-700');
    }
    
    // 显示注册表单
    function showRegisterForm() {
      registerForm.classList.remove('hidden');
      loginForm.classList.add('hidden');
      showRegisterBtn.classList.remove('bg-gray-700');
      showRegisterBtn.classList.add('bg-primary');
      showLoginBtn.classList.remove('bg-primary');
      showLoginBtn.classList.add('bg-gray-700');
    }
    
    // 切换到主页
    function switchToHomePage(userData) {
      gameState.currentUser = userData;
      authPage.classList.add('hidden');
      homePage.classList.remove('hidden');
      
      // 更新用户信息显示
      usernameDisplay.textContent = userData.username;
      
      // 生成并显示用户秘钥
      const userKey = generateUserKey(userData.username);
      userKeyDisplay.textContent = userKey;
      userKeyDisplayMobile.textContent = userKey;
      
      // 更新关卡解锁状态
      if (userData.levelProgress) {
        updateLevelLocks(userData.levelProgress);
      }
      
      // 渲染角色和关卡
      renderCharacters();
      renderLevels();
    }
    
    // 渲染角色列表
    function renderCharacters() {
      charactersContainer.innerHTML = '';
      
      gameState.characters.forEach((character, index) => {
        // 检查角色是否已解锁（对应关卡是否已解锁）
        const characterLevel = gameState.levels.find(level => level.characterId === character.id);
        const isUnlocked = characterLevel && !characterLevel.locked;
        
        const characterCard = document.createElement('div');
        characterCard.className = `glass rounded-lg p-3 cursor-pointer character-card ${!isUnlocked ? 'character-locked' : ''}`;
        characterCard.innerHTML = `
          <div class="flex items-center">
            <div class="w-12 h-12 rounded-lg overflow-hidden mr-3 pixel-art">
              <img src="${character.image}" alt="${character.name}" class="w-full h-full object-cover">
            </div>
            <div class="flex-1">
              <h3 class="font-medium">${character.name}</h3>
              <p class="text-xs text-gray-400">${character.level}</p>
            </div>
            ${!isUnlocked ? '<i data-lucide="lock" class="text-gray-500"></i>' : ''}
          </div>
        `;
        
        if (isUnlocked) {
          characterCard.addEventListener('click', () => showCharacterDetails(character));
        }
        
        charactersContainer.appendChild(characterCard);
      });
      
      // 重新渲染图标
      lucide.createIcons();
    }
    
    // 渲染关卡列表
    function renderLevels() {
      levelsContainer.innerHTML = '';
      
      gameState.levels.forEach((level, index) => {
        const levelCard = document.createElement('div');
        levelCard.className = `glass rounded-lg p-4 cursor-pointer computer-hover ${level.locked ? 'locked-computer' : ''}`;
        
        // 计算延迟动画，使关卡卡片依次出现
        levelCard.style.animation = `fadeIn 0.5s ease-out forwards ${index * 0.1}s`;
        levelCard.style.opacity = '0';
        
        levelCard.innerHTML = `
          <div class="text-center">
            <div class="w-32 h-32 mx-auto mb-3 relative pixel-art">
              <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/013c5cb111744edd886b1c7fe1a4ff09~tplv-a9rns2rl98-image.image?rcl=2025121216030395467CD91F7E894B454B&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1768118643&x-signature=RExUSdqoMW1ClijZz5%2Bl7Q0oDTQ%3D" alt="${level.name}" class="w-full h-full object-contain">
              ${level.locked ? `
                <div class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-lg">
                  <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/0ff8b54f87874ab0852777cdcdeb92d5~tplv-a9rns2rl98-image.image?rcl=2025121216030395467CD91F7E894B454B&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1768118643&x-signature=aWnaHb6f8eEnBTZEssRKJWxUDE0%3D" alt="Locked" class="w-16 h-16 object-contain">
                </div>
              ` : ''}
            </div>
            <h3 class="font-bold text-lg">${level.name}</h3>
            <p class="text-sm text-gray-400">${level.locked ? '完成前一关卡解锁' : '点击进入'}</p>
          </div>
        `;
        
        if (!level.locked) {
          levelCard.addEventListener('click', () => {
            // 如果是第一关（CSP-J），模拟进入关卡
            if (level.id === 'cspj') {
              // 这里可以添加实际的关卡逻辑
              // 目前显示未开发提示
              notDevelopedModal.classList.remove('hidden');
            } else {
              // 其他关卡显示未开发提示
              notDevelopedModal.classList.remove('hidden');
            }
          });
        }
        
        levelsContainer.appendChild(levelCard);
      });
    }
    
    // 显示角色详情
    function showCharacterDetails(character) {
      document.getElementById('modalCharacterName').textContent = character.name;
      document.getElementById('modalCharacterImage').innerHTML = `<img src="${character.image}" alt="${character.name}" class="w-full h-full object-cover">`;
      document.getElementById('modalCharacterLevel').textContent = character.level;
      document.getElementById('modalCharacterBio').textContent = character.bio;
      
      // 渲染技能列表
      const skillsContainer = document.getElementById('modalCharacterSkills');
      skillsContainer.innerHTML = '';
      
      character.skills.forEach(skill => {
        const skillElement = document.createElement('div');
        skillElement.className = 'bg-gray-800/50 rounded-lg p-3';
        skillElement.innerHTML = `
          <h4 class="font-semibold text-primary">${skill.name}</h4>
          <p class="text-sm text-gray-300">${skill.description}</p>
        `;
        skillsContainer.appendChild(skillElement);
      });
      
      characterModal.classList.remove('hidden');
    }
    
    // 复制文本到剪贴板
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        // 显示复制成功提示
        copySuccessToast.classList.remove('translate-y-16', 'opacity-0');
        
        // 3秒后隐藏提示
        setTimeout(() => {
          copySuccessToast.classList.add('translate-y-16', 'opacity-0');
        }, 3000);
      }).catch(err => {
        console.error('复制失败:', err);
      });
    }
    
    // 从剪贴板粘贴文本
    function pasteFromClipboard(inputElement) {
      navigator.clipboard.readText().then(text => {
        inputElement.value = text;
      }).catch(err => {
        console.error('粘贴失败:', err);
      });
    }
    
    // 事件监听器
    document.addEventListener('DOMContentLoaded', () => {
      // 初始化代码雨效果
      initCodeRain();
      
      // 登录/注册表单切换
      showLoginBtn.addEventListener('click', showLoginForm);
      showRegisterBtn.addEventListener('click', showRegisterForm);
      
      // 登录表单提交
      loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const keyInput = document.getElementById('loginKey').value.trim();
        
        if (!keyInput) {
          alert('请输入秘钥');
          return;
        }
        
        // 解析秘钥
        const userData = parseUserKey(keyInput);
        
        if (userData) {
          // 登录成功，切换到主页
          switchToHomePage(userData);
        } else {
          // 显示错误动画
          loginForm.classList.add('animate-shake');
          setTimeout(() => {
            loginForm.classList.remove('animate-shake');
          }, 500);
          alert('无效的秘钥');
        }
      });
      
      // 注册表单提交
      registerForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value.trim();
        
        if (!username) {
          alert('请输入用户名');
          return;
        }
        
        // 创建新用户数据
        const newUserData = {
          username,
          timestamp: Date.now(),
          levelProgress: '100000' // 默认解锁第一关
        };
        
        // 注册成功，切换到主页
        switchToHomePage(newUserData);
      });
      
      // 登出按钮
      logoutBtn.addEventListener('click', () => {
        gameState.currentUser = null;
        homePage.classList.add('hidden');
        authPage.classList.remove('hidden');
        
        // 重置表单
        loginForm.reset();
        registerForm.reset();
        showLoginForm();
      });
      
      // 复制秘钥按钮
      copyKeyBtn.addEventListener('click', () => {
        copyToClipboard(userKeyDisplay.textContent);
      });
      
      copyKeyBtnMobile.addEventListener('click', () => {
        copyToClipboard(userKeyDisplayMobile.textContent);
      });
      
      // 关闭角色详情模态框
      closeCharacterModal.addEventListener('click', () => {
        characterModal.classList.add('hidden');
      });
      
      // 关闭未开发提示模态框
      closeNotDevelopedModal.addEventListener('click', () => {
        notDevelopedModal.classList.add('hidden');
      });
      
      // 点击模态框背景关闭
      characterModal.addEventListener('click', (e) => {
        if (e.target === characterModal) {
          characterModal.classList.add('hidden');
        }
      });
      
      notDevelopedModal.addEventListener('click', (e) => {
        if (e.target === notDevelopedModal) {
          notDevelopedModal.classList.add('hidden');
        }
      });
      
      // 粘贴秘钥按钮
      pasteKeyBtn.addEventListener('click', () => {
        pasteFromClipboard(document.getElementById('loginKey'));
      });
      
      // 防代码窃取 - 禁用右键菜单
      document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        return false;
      });
      
      // 防代码窃取 - 禁用Ctrl键组合
      document.addEventListener('keydown', (e) => {
        // 禁用Ctrl+C, Ctrl+V, Ctrl+X, Ctrl+U, Ctrl+S
        if ((e.ctrlKey || e.metaKey) && ['c', 'v', 'x', 'u', 's'].includes(e.key.toLowerCase())) {
          e.preventDefault();
          return false;
        }
        
        // 禁用F12, Ctrl+Shift+I, Ctrl+Shift+J
        if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['i', 'j'].includes(e.key.toLowerCase()))) {
          e.preventDefault();
          return false;
        }
      });
    });
  </script>
</body>
</html>
