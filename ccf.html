<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fight CCF - CCFä¸»å¸­å…³å¡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        dark: '#1F2937',
                        light: '#F3F4F6',
                        danger: '#EF4444',
                        success: '#22C55E',
                        warning: '#F59E0B',
                        info: '#3B82F6'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'float': 'float 3s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'slide-in': 'slideIn 0.5s ease-out',
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'attack': 'attack 0.3s ease-out',
                        'hit': 'hit 0.3s ease-out',
                        'skill': 'skill 0.5s ease-out',
                        'victory': 'victory 1s ease-out',
                        'defeat': 'defeat 1s ease-out',
                        'spin-slow': 'spin 3s linear infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        'zoom-in-out': 'zoomInOut 2s ease-in-out infinite'
                    },
                    keyframes: {
                        glow: {
                            '0%': { boxShadow: '0 0 5px #fff, 0 0 10px #fff, 0 0 15px #0073e6, 0 0 20px #0073e6' },
                            '100%': { boxShadow: '0 0 10px #fff, 0 0 20px #fff, 0 0 30px #0073e6, 0 0 40px #0073e6' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        slideIn: {
                            '0%': { transform: 'translateX(-100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        attack: {
                            '0%': { transform: 'translateX(0)' },
                            '50%': { transform: 'translateX(50px)' },
                            '100%': { transform: 'translateX(0)' }
                        },
                        hit: {
                            '0%': { transform: 'translateX(0)' },
                            '50%': { transform: 'translateX(-20px)', opacity: '0.7' },
                            '100%': { transform: 'translateX(0)', opacity: '1' }
                        },
                        skill: {
                            '0%': { transform: 'scale(1)', opacity: '0.5' },
                            '50%': { transform: 'scale(1.2)', opacity: '1' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        victory: {
                            '0%': { transform: 'translateY(0)' },
                            '25%': { transform: 'translateY(-20px)' },
                            '50%': { transform: 'translateY(0)' },
                            '75%': { transform: 'translateY(-10px)' },
                            '100%': { transform: 'translateY(0)' }
                        },
                        defeat: {
                            '0%': { transform: 'rotate(0deg)' },
                            '25%': { transform: 'rotate(-5deg)' },
                            '50%': { transform: 'rotate(5deg)' },
                            '75%': { transform: 'rotate(-3deg)' },
                            '100%': { transform: 'rotate(0deg)' }
                        },
                        zoomInOut: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.05)' }
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .text-shadow-lg {
                text-shadow: 0 4px 8px rgba(0,0,0,0.2);
            }
            .glass {
                background: rgba(255, 255, 255, 0.25);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.18);
            }
            .health-bar {
                transition: width 0.3s ease;
            }
            .energy-bar {
                transition: width 0.3s ease;
            }
            .cooldown-overlay {
                background: rgba(0, 0, 0, 0.7);
                transition: opacity 0.3s ease;
            }
            .fighter {
                transition: all 0.3s ease;
            }
            .projectile {
                position: absolute;
                width: 20px;
                height: 20px;
                background: #6366f1;
                border-radius: 50%;
                animation: projectileMove 0.5s linear;
            }
            @keyframes projectileMove {
                from {
                    transform: translateX(0);
                }
                to {
                    transform: translateX(300px);
                }
            }
            .explosion {
                position: absolute;
                width: 50px;
                height: 50px;
                background: radial-gradient(circle, #6366f1 0%, #4f46e5 100%);
                border-radius: 50%;
                animation: explosion 0.5s ease-out forwards;
            }
            @keyframes explosion {
                0% {
                    transform: scale(0);
                    opacity: 1;
                }
                100% {
                    transform: scale(2);
                    opacity: 0;
                }
            }
            .final-blast {
                position: absolute;
                width: 200px;
                height: 200px;
                background: radial-gradient(circle, #6366f1 0%, #4f46e5 50%, #4338ca 100%);
                border-radius: 50%;
                animation: finalBlast 1.5s ease-out forwards;
            }
            @keyframes finalBlast {
                0% {
                    transform: scale(0);
                    opacity: 1;
                }
                50% {
                    opacity: 0.8;
                }
                100% {
                    transform: scale(5);
                    opacity: 0;
                }
            }
            .president-aura {
                position: absolute;
                width: 120px;
                height: 120px;
                border: 4px solid rgba(99, 102, 241, 0.6);
                border-radius: 50%;
                animation: presidentAura 2s ease-in-out infinite;
            }
            @keyframes presidentAura {
                0% {
                    transform: scale(1);
                    opacity: 0.6;
                }
                50% {
                    transform: scale(1.2);
                    opacity: 0.3;
                }
                100% {
                    transform: scale(1);
                    opacity: 0.6;
                }
            }
            .code-rain {
                position: absolute;
                color: rgba(99, 102, 241, 0.3);
                font-family: monospace;
                font-size: 14px;
                animation: codeRain 3s linear infinite;
            }
            @keyframes codeRain {
                0% {
                    transform: translateY(-100px);
                    opacity: 1;
                }
                100% {
                    transform: translateY(400px);
                    opacity: 0;
                }
            }
        }
    </style>
    <style>
        body {
            background: linear-gradient(135deg, #1e1b4b 0%, #2e1065 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .battlefield {
            position: relative;
            height: 400px;
            background: linear-gradient(to bottom, #0f172a 0%, #1e1b4b 100%);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .battlefield::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }
        
        .fighter {
            position: absolute;
            bottom: 50px;
            width: 80px;
            height: 120px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        
        .player {
            left: 100px;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        }
        
        .enemy {
            right: 100px;
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        }
        
        .ui-panel {
            background: rgba(31, 41, 55, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
        }
        
        .skill-button {
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .skill-button:hover:not(.disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .skill-button.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .countdown {
            font-variant-numeric: tabular-nums;
        }
        
        .floating-text {
            position: absolute;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
        }
        
        @keyframes floatUp {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-50px);
                opacity: 0;
            }
        }
        
        .battle-log {
            max-height: 200px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #6366f1 #1F2937;
        }
        
        .battle-log::-webkit-scrollbar {
            width: 6px;
        }
        
        .battle-log::-webkit-scrollbar-track {
            background: #1F2937;
        }
        
        .battle-log::-webkit-scrollbar-thumb {
            background: #6366f1;
            border-radius: 3px;
        }
        
        .algorithm-node {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #6366f1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            animation: float 3s ease-in-out infinite;
        }
        
        .connection-line {
            position: absolute;
            height: 2px;
            background: rgba(99, 102, 241, 0.5);
            transform-origin: left center;
        }
        
        /* ç¦ç”¨å³é”®å’ŒCtrlé”® */
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* ç‰¹æ®Šæ•ˆæœ */
        .boss-intro {
            animation: bossIntro 2s ease-out;
        }
        
        @keyframes bossIntro {
            0% {
                transform: scale(0.5) rotate(180deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.1) rotate(0deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        
        .final-boss-health {
            background: linear-gradient(90deg, #06b6d4, #0891b2);
        }
        
        .final-boss-energy {
            background: linear-gradient(90deg, #6366f1, #4f46e5);
        }
    </style>
</head>
<body class="font-sans text-gray-100">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="glass sticky top-0 z-50 px-6 py-4 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <button id="back-btn" class="bg-dark/50 hover:bg-dark/80 text-white p-2 rounded-lg transition">
                <i class="fa fa-arrow-left"></i>
            </button>
            <h1 class="text-2xl font-bold text-shadow">Fight CCF - æœ€ç»ˆæŒ‘æˆ˜</h1>
        </div>
        <div class="flex items-center space-x-4">
            <div class="bg-dark/50 px-4 py-2 rounded-lg">
                <span class="text-sm text-gray-400">å…³å¡:</span>
                <span id="current-chapter" class="ml-2 font-semibold">6-1</span>
            </div>
            <div class="bg-dark/50 px-4 py-2 rounded-lg">
                <span class="text-sm text-gray-400">æ—¶é—´:</span>
                <span id="countdown" class="ml-2 font-semibold countdown">180</span>
            </div>
        </div>
    </header>
    
    <!-- ä¸»è¦å†…å®¹ -->
    <main class="container mx-auto px-4 py-8">
        <!-- æˆ˜åœºåŒºåŸŸ -->
        <div class="battlefield mb-6">
            <!-- ä»£ç é›¨èƒŒæ™¯ -->
            <div id="code-rain-container" class="absolute inset-0 pointer-events-none"></div>
            
            <!-- ç©å®¶ -->
            <div id="player" class="fighter player">
                <i class="fa fa-star"></i>
            </div>
            
            <!-- æ•Œäºº -->
            <div id="enemy" class="fighter enemy boss-intro">
                <i class="fa fa-user-circle"></i>
            </div>
            
            <!-- CCFä¸»å¸­å…‰ç¯ -->
            <div id="president-aura" class="president-aura"></div>
            
            <!-- æˆ˜æ–—æ•ˆæœå°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
        </div>
        
        <!-- çŠ¶æ€é¢æ¿ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- ç©å®¶çŠ¶æ€ -->
            <div class="ui-panel">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">CCFä¸»å¸­</h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-yellow-400">
                            <i class="fa fa-bolt"></i>
                            <span id="player-energy">100</span>
                        </span>
                    </div>
                </div>
                
                <!-- ç”Ÿå‘½å€¼ -->
                <div class="mb-4">
                    <div class="flex justify-between text-sm mb-1">
                        <span>ç”Ÿå‘½å€¼</span>
                        <span id="player-health-text">200/200</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-3">
                        <div id="player-health-bar" class="health-bar bg-green-500 h-3 rounded-full" style="width: 100%"></div>
                    </div>
                </div>
                
                <!-- èƒ½é‡å€¼ -->
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span>èƒ½é‡å€¼</span>
                        <span id="player-energy-text">100/100</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-3">
                        <div id="player-energy-bar" class="energy-bar bg-yellow-400 h-3 rounded-full" style="width: 100%"></div>
                    </div>
                </div>
            </div>
            
            <!-- æ•ŒäººçŠ¶æ€ -->
            <div class="ui-panel">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg" id="enemy-name">ç¼–ç¨‹ä¹‹ç¥</h3>
                    <div class="flex items-center space-x-1">
                        <span class="text-cyan-500">Lv.</span>
                        <span id="enemy-level">15</span>
                    </div>
                </div>
                
                <!-- ç”Ÿå‘½å€¼ -->
                <div class="mb-4">
                    <div class="flex justify-between text-sm mb-1">
                        <span>ç”Ÿå‘½å€¼</span>
                        <span id="enemy-health-text">500/500</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-3">
                        <div id="enemy-health-bar" class="health-bar final-boss-health h-3 rounded-full" style="width: 100%"></div>
                    </div>
                </div>
                
                <!-- ç‰¹æ®Šèƒ½åŠ› -->
                <div>
                    <div class="text-sm mb-1">ç‰¹æ®Šèƒ½åŠ›</div>
                    <div class="flex flex-wrap gap-2">
                        <span class="bg-cyan-500/20 text-cyan-300 text-xs px-2 py-1 rounded-full">ä»£ç é›¨</span>
                        <span class="bg-purple-500/20 text-purple-300 text-xs px-2 py-1 rounded-full">æ—¶ç©ºå†»ç»“</span>
                        <span class="bg-red-500/20 text-red-300 text-xs px-2 py-1 rounded-full">ç»ˆæçˆ†ç‚¸</span>
                    </div>
                </div>
            </div>
            
            <!-- æˆ˜æ–—æ—¥å¿— -->
            <div class="ui-panel">
                <h3 class="font-bold text-lg mb-4">æˆ˜æ–—æ—¥å¿—</h3>
                <div id="battle-log" class="battle-log text-sm space-y-2">
                    <div class="text-gray-400">æœ€ç»ˆä¹‹æˆ˜å¼€å§‹ï¼</div>
                </div>
            </div>
        </div>
        
        <!-- æŠ€èƒ½é¢æ¿ -->
        <div class="ui-panel">
            <h3 class="font-bold text-lg mb-4">æœ€ç»ˆæŠ€èƒ½</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- æ™®æ”» -->
                <div class="skill-button bg-gray-800 rounded-lg p-4 text-center" data-skill="normal">
                    <div class="w-12 h-12 mx-auto bg-gray-700 rounded-full mb-2 flex items-center justify-center">
                        <span class="text-xl font-bold">I</span>
                    </div>
                    <p class="font-medium">ä»£ç å®¡åˆ¤</p>
                    <p class="text-xs text-gray-400">åŸºç¡€æ”»å‡»</p>
                </div>
                
                <!-- ä¸€æŠ€èƒ½ -->
                <div class="skill-button bg-gray-800 rounded-lg p-4 text-center" data-skill="skill1">
                    <div class="w-12 h-12 mx-auto bg-blue-500/20 rounded-full mb-2 flex items-center justify-center">
                        <span class="text-xl font-bold">J</span>
                    </div>
                    <p class="font-medium">æ”¿ç­–åˆ¶å®š</p>
                    <p class="text-xs text-gray-400">50ç‚¹ä¼¤å®³</p>
                </div>
                
                <!-- äºŒæŠ€èƒ½ -->
                <div class="skill-button bg-gray-800 rounded-lg p-4 text-center" data-skill="skill2">
                    <div class="w-12 h-12 mx-auto bg-green-500/20 rounded-full mb-2 flex items-center justify-center">
                        <span class="text-xl font-bold">K</span>
                    </div>
                    <p class="font-medium">ç«èµ›åˆ¶è£</p>
                    <p class="text-xs text-gray-400">65ç‚¹ä¼¤å®³</p>
                </div>
                
                <!-- ä¸‰æŠ€èƒ½ -->
                <div class="skill-button bg-gray-800 rounded-lg p-4 text-center" data-skill="skill3">
                    <div class="w-12 h-12 mx-auto bg-purple-500/20 rounded-full mb-2 flex items-center justify-center">
                        <span class="text-xl font-bold">L</span>
                    </div>
                    <p class="font-medium">æœ€ç»ˆè£å†³</p>
                    <p class="text-xs text-gray-400">100ç‚¹ä¼¤å®³</p>
                </div>
            </div>
        </div>
        
        <!-- æŒ‰é”®è¯´æ˜ -->
        <div class="mt-6 bg-dark/50 rounded-lg p-4">
            <h4 class="font-bold mb-2">æŒ‰é”®è¯´æ˜</h4>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div class="flex items-center space-x-2">
                    <span class="bg-gray-700 px-2 py-1 rounded">W</span>
                    <span>å‘ä¸Šç§»åŠ¨</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="bg-gray-700 px-2 py-1 rounded">S</span>
                    <span>å‘ä¸‹ç§»åŠ¨</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="bg-gray-700 px-2 py-1 rounded">A</span>
                    <span>å‘å·¦ç§»åŠ¨</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="bg-gray-700 px-2 py-1 rounded">D</span>
                    <span>å‘å³ç§»åŠ¨</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="bg-primary px-2 py-1 rounded">I</span>
                    <span>æ™®æ”»</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="bg-blue-500 px-2 py-1 rounded">J</span>
                    <span>ä¸€æŠ€èƒ½</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="bg-green-500 px-2 py-1 rounded">K</span>
                    <span>äºŒæŠ€èƒ½</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="bg-purple-500 px-2 py-1 rounded">L</span>
                    <span>ä¸‰æŠ€èƒ½</span>
                </div>
            </div>
        </div>
    </main>
    
    <!-- èƒœåˆ©/å¤±è´¥æ¨¡æ€æ¡† -->
    <div id="result-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
        <div class="bg-dark text-white rounded-lg p-8 max-w-md w-full text-center animate-fade-in">
            <div id="result-icon" class="text-6xl mb-4"></div>
            <h2 id="result-title" class="text-2xl font-bold mb-2"></h2>
            <p id="result-message" class="mb-6"></p>
            <div class="flex flex-col space-y-3">
                <button id="restart-btn" class="bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg transition">
                    é‡æ–°æŒ‘æˆ˜
                </button>
                <button id="home-btn" class="bg-gray-800 hover:bg-gray-700 text-white py-3 rounded-lg transition">
                    è¿”å›ä¸»é¡µ
                </button>
            </div>
        </div>
    </div>
    
    <!-- æœ€ç»ˆèƒœåˆ©æ¨¡æ€æ¡† -->
    <div id="final-victory-modal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 hidden">
        <div class="bg-gradient-to-br from-indigo-900 to-purple-900 text-white rounded-lg p-8 max-w-lg w-full text-center animate-fade-in">
            <div class="text-8xl mb-6 animate-bounce-slow">
                <i class="fa fa-trophy text-yellow-400"></i>
            </div>
            <h2 class="text-3xl font-bold mb-4 text-shadow-lg">ğŸ‰ æ­å–œé€šå…³ï¼ ğŸ‰</h2>
            <p class="text-lg mb-6">ä½ å·²ç»æˆåŠŸå‡»è´¥äº†æ‰€æœ‰ç¼–ç¨‹ç«èµ›çš„æŒ‘æˆ˜ï¼Œæˆä¸ºäº†çœŸæ­£çš„ç¼–ç¨‹å¤§å¸ˆï¼</p>
            <div class="mb-8">
                <div class="text-sm text-gray-300 mb-2">ä½ çš„æˆå°±ï¼š</div>
                <div class="flex flex-wrap justify-center gap-2">
                    <span class="bg-yellow-500/20 text-yellow-300 px-3 py-1 rounded-full">å…¨å…³å¡é€šå…³</span>
                    <span class="bg-purple-500/20 text-purple-300 px-3 py-1 rounded-full">è§£é”æ‰€æœ‰è§’è‰²</span>
                    <span class="bg-blue-500/20 text-blue-300 px-3 py-1 rounded-full">ç¼–ç¨‹ä¹‹ç¥</span>
                </div>
            </div>
            <button id="play-again-btn" class="bg-primary hover:bg-blue-600 text-white py-3 px-8 rounded-lg transition text-lg">
                å†æ¥ä¸€å±€
            </button>
        </div>
    </div>
    
    <script>
        // æ¸¸æˆæ•°æ®
        const gameState = {
            player: {
                health: 200,
                maxHealth: 200,
                energy: 100,
                maxEnergy: 100,
                position: { x: 100, y: 50 },
                skills: {
                    normal: { name: 'ä»£ç å®¡åˆ¤', damage: 25, energy: 0, cooldown: 0 },
                    skill1: { name: 'æ”¿ç­–åˆ¶å®š', damage: 50, energy: 50, cooldown: 3 },
                    skill2: { name: 'ç«èµ›åˆ¶è£', damage: 65, energy: 65, cooldown: 5 },
                    skill3: { name: 'æœ€ç»ˆè£å†³', damage: 100, energy: 100, cooldown: 10 }
                },
                currentCooldowns: {}
            },
            enemy: {
                health: 500,
                maxHealth: 500,
                position: { x: 0, y: 50 },
                damage: 45,
                attackInterval: 1000,
                lastAttack: 0,
                phase: 1, // 1: æ™®é€šé˜¶æ®µ, 2: ç¬¬äºŒé˜¶æ®µ, 3: æœ€ç»ˆé˜¶æ®µ
                specialAttackCooldown: 0
            },
            countdown: 180,
            isGameOver: false,
            isPlayerTurn: true,
            isFrozen: false, // æ—¶ç©ºå†»ç»“çŠ¶æ€
            codeRainActive: false,
            currentChapter: 6,
            currentLevel: 1
        };
        
        // DOMå…ƒç´ 
        const player = document.getElementById('player');
        const enemy = document.getElementById('enemy');
        const presidentAura = document.getElementById('president-aura');
        const playerHealthBar = document.getElementById('player-health-bar');
        const playerHealthText = document.getElementById('player-health-text');
        const playerEnergyBar = document.getElementById('player-energy-bar');
        const playerEnergyText = document.getElementById('player-energy-text');
        const enemyHealthBar = document.getElementById('enemy-health-bar');
        const enemyHealthText = document.getElementById('enemy-health-text');
        const enemyName = document.getElementById('enemy-name');
        const enemyLevel = document.getElementById('enemy-level');
        const countdownElement = document.getElementById('countdown');
        const battleLog = document.getElementById('battle-log');
        const codeRainContainer = document.getElementById('code-rain-container');
        const resultModal = document.getElementById('result-modal');
        const resultIcon = document.getElementById('result-icon');
        const resultTitle = document.getElementById('result-title');
        const resultMessage = document.getElementById('result-message');
        const restartBtn = document.getElementById('restart-btn');
        const homeBtn = document.getElementById('home-btn');
        const backBtn = document.getElementById('back-btn');
        const currentChapterElement = document.getElementById('current-chapter');
        const finalVictoryModal = document.getElementById('final-victory-modal');
        const playAgainBtn = document.getElementById('play-again-btn');
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initializeGame();
            startGameLoop();
            createCodeRain();
            
            // ç¦ç”¨å³é”®å’ŒCtrlé”®
            disableRightClickAndCtrl();
        });
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initializeGame() {
            // è®¾ç½®æ•Œäººä½ç½®
            const battlefieldRect = document.querySelector('.battlefield').getBoundingClientRect();
            gameState.enemy.position.x = battlefieldRect.width - 180;
            
            // æ›´æ–°UI
            updatePlayerUI();
            updateEnemyUI();
            currentChapterElement.textContent = `${gameState.currentChapter}-${gameState.currentLevel}`;
            
            // è®¾ç½®å…‰ç¯ä½ç½®
            updatePresidentAura();
            
            // æ·»åŠ æˆ˜æ–—æ—¥å¿—
            addBattleLog('æœ€ç»ˆä¹‹æˆ˜å¼€å§‹ï¼ä½ é¢å¯¹çš„æ˜¯ç¼–ç¨‹ä¹‹ç¥ï¼', 'warning');
            addBattleLog('å°å¿ƒåº”å¯¹ï¼Œè¿™å°†æ˜¯ä½ æœ€è‰°éš¾çš„æŒ‘æˆ˜...', 'warning');
        }
        
        // æ›´æ–°ä¸»å¸­å…‰ç¯ä½ç½®
        function updatePresidentAura() {
            const enemyRect = enemy.getBoundingClientRect();
            presidentAura.style.left = `${enemyRect.left - 20}px`;
            presidentAura.style.top = `${enemyRect.top - 20}px`;
        }
        
        // åˆ›å»ºä»£ç é›¨
        function createCodeRain() {
            const codeChars = '01ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆãƒŠãƒ‹ãƒŒãƒãƒãƒãƒ’ãƒ•ãƒ˜ãƒ›ãƒãƒŸãƒ ãƒ¡ãƒ¢ãƒ¤ãƒ¦ãƒ¨ãƒ©ãƒªãƒ«ãƒ¬ãƒ­ãƒ¯ãƒ²ãƒ³';
            
            function createCodeDrop() {
                if (gameState.isGameOver) return;
                
                const drop = document.createElement('div');
                drop.className = 'code-rain';
                drop.textContent = codeChars[Math.floor(Math.random() * codeChars.length)];
                drop.style.left = `${Math.random() * 100}%`;
                drop.style.animationDuration = `${2 + Math.random() * 2}s`;
                drop.style.animationDelay = `${Math.random() * 2}s`;
                
                codeRainContainer.appendChild(drop);
                
                setTimeout(() => {
                    if (drop.parentNode) {
                        drop.parentNode.removeChild(drop);
                    }
                }, 4000);
            }
            
            // å®šæœŸåˆ›å»ºä»£ç é›¨
            setInterval(createCodeDrop, 200);
        }
        
        // å¼€å§‹æ¸¸æˆå¾ªç¯
        function startGameLoop() {
            const gameLoop = setInterval(() => {
                if (gameState.isGameOver) {
                    clearInterval(gameLoop);
                    return;
                }
                
                // æ›´æ–°å€’è®¡æ—¶
                gameState.countdown--;
                countdownElement.textContent = gameState.countdown;
                
                if (gameState.countdown <= 0) {
                    endGame(false);
                }
                
                // æ£€æŸ¥Bossé˜¶æ®µè½¬æ¢
                checkBossPhase();
                
                // æ•ŒäººAI
                if (!gameState.isPlayerTurn && !gameState.isFrozen) {
                    const now = Date.now();
                    if (now - gameState.enemy.lastAttack > gameState.enemy.attackInterval) {
                        enemyAttack();
                        gameState.enemy.lastAttack = now;
                    }
                }
                
                // æ›´æ–°æŠ€èƒ½å†·å´
                updateCooldowns();
                
                // æ¢å¤èƒ½é‡
                if (gameState.player.energy < gameState.player.maxEnergy && !gameState.isFrozen) {
                    gameState.player.energy = Math.min(gameState.player.maxEnergy, gameState.player.energy + 1.5);
                    updatePlayerUI();
                }
                
                // ç‰¹æ®Šæ”»å‡»å†·å´
                if (gameState.enemy.specialAttackCooldown > 0) {
                    gameState.enemy.specialAttackCooldown--;
                }
                
                // æ—¶ç©ºå†»ç»“æ•ˆæœ
                if (gameState.isFrozen) {
                    gameState.frozenTime = (gameState.frozenTime || 0) + 1;
                    if (gameState.frozenTime >= 3) {
                        gameState.isFrozen = false;
                        gameState.frozenTime = 0;
                        addBattleLog('æ—¶ç©ºå†»ç»“æ•ˆæœè§£é™¤ï¼', 'success');
                        document.body.style.filter = '';
                    }
                }
            }, 1000);
        }
        
        // æ£€æŸ¥Bossé˜¶æ®µ
        function checkBossPhase() {
            if (gameState.enemy.health <= gameState.enemy.maxHealth * 0.3 && gameState.enemy.phase === 1) {
                // è¿›å…¥ç¬¬äºŒé˜¶æ®µ
                gameState.enemy.phase = 2;
                gameState.enemy.attackInterval = 800;
                gameState.enemy.damage = 55;
                enemy.style.background = 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)';
                presidentAura.style.borderColor = 'rgba(220, 38, 38, 0.6)';
                addBattleLog('è­¦å‘Šï¼ç¼–ç¨‹ä¹‹ç¥è¿›å…¥äº†ç‹‚æš´çŠ¶æ€ï¼', 'error');
                addBattleLog('æ”»å‡»é€Ÿåº¦å’Œä¼¤å®³å¤§å¹…æå‡ï¼', 'error');
                
                // ç«‹å³å‘åŠ¨ç‰¹æ®Šæ”»å‡»
                gameState.enemy.specialAttackCooldown = 0;
            }
        }
        
        // ç©å®¶ç§»åŠ¨
        function movePlayer(direction) {
            if (gameState.isGameOver || gameState.isFrozen) return;
            
            const battlefieldRect = document.querySelector('.battlefield').getBoundingClientRect();
            const speed = 20;
            
            switch (direction) {
                case 'up':
                    gameState.player.position.y = Math.max(50, gameState.player.position.y - speed);
                    break;
                case 'down':
                    gameState.player.position.y = Math.min(battlefieldRect.height - 170, gameState.player.position.y + speed);
                    break;
                case 'left':
                    gameState.player.position.x = Math.max(50, gameState.player.position.x - speed);
                    break;
                case 'right':
                    gameState.player.position.x = Math.min(battlefieldRect.width / 2 - 90, gameState.player.position.x + speed);
                    break;
            }
            
            updatePlayerPosition();
        }
        
        // æ›´æ–°ç©å®¶ä½ç½®
        function updatePlayerPosition() {
            player.style.left = `${gameState.player.position.x}px`;
            player.style.bottom = `${gameState.player.position.y}px`;
        }
        
        // ç©å®¶æ”»å‡»
        function playerAttack(skillType) {
            if (gameState.isGameOver || !gameState.isPlayerTurn || gameState.isFrozen) return;
            
            const skill = gameState.player.skills[skillType];
            
            // æ£€æŸ¥èƒ½é‡å’Œå†·å´
            if (gameState.player.energy < skill.energy) {
                addBattleLog('èƒ½é‡ä¸è¶³ï¼', 'warning');
                return;
            }
            
            if (gameState.player.currentCooldowns[skillType] > 0) {
                addBattleLog(`${skill.name} å†·å´ä¸­ (${gameState.player.currentCooldowns[skillType]}s)`, 'warning');
                return;
            }
            
            // æ¶ˆè€—èƒ½é‡
            gameState.player.energy -= skill.energy;
            
            // è®¾ç½®å†·å´
            gameState.player.currentCooldowns[skillType] = skill.cooldown;
            
            // æ’­æ”¾æ”»å‡»åŠ¨ç”»
            playAttackAnimation(skillType);
            
            // è®¡ç®—ä¼¤å®³
            let damage = skill.damage;
            
            // ç¬¬äºŒé˜¶æ®µä¼¤å®³åŠ æˆ
            if (gameState.enemy.phase === 2) {
                damage = Math.floor(damage * 1.2);
                addBattleLog(`æ„¤æ€’çš„ä¸€å‡»ï¼${skill.name} é€ æˆ ${damage} ç‚¹ä¼¤å®³`, 'critical');
            } else {
                addBattleLog(`${skill.name} é€ æˆ ${damage} ç‚¹ä¼¤å®³`);
            }
            
            // æ‰£é™¤æ•Œäººç”Ÿå‘½å€¼
            gameState.enemy.health = Math.max(0, gameState.enemy.health - damage);
            
            // æ›´æ–°UI
            updatePlayerUI();
            updateEnemyUI();
            
            // æ£€æŸ¥æ•Œäººæ˜¯å¦æ­»äº¡
            if (gameState.enemy.health <= 0) {
                endGame(true);
                return;
            }
            
            // åˆ‡æ¢å›åˆ
            gameState.isPlayerTurn = false;
        }
        
        // æ’­æ”¾æ”»å‡»åŠ¨ç”»
        function playAttackAnimation(skillType) {
            // ç©å®¶æ”»å‡»åŠ¨ç”»
            player.classList.add('animate-attack');
            setTimeout(() => {
                player.classList.remove('animate-attack');
            }, 300);
            
            // æ•Œäººå—å‡»åŠ¨ç”»
            setTimeout(() => {
                enemy.classList.add('animate-hit');
                setTimeout(() => {
                    enemy.classList.remove('animate-hit');
                }, 300);
                
                // åˆ›å»ºä¼¤å®³æ•°å­—
                createDamageNumber(gameState.enemy.health, enemy);
                
                // æ ¹æ®æŠ€èƒ½ç±»å‹åˆ›å»ºä¸åŒçš„ç‰¹æ•ˆ
                if (skillType === 'skill1') {
                    createPolicyMakingEffect();
                } else if (skillType === 'skill2') {
                    createCompetitionSanctionEffect();
                } else if (skillType === 'skill3') {
                    createFinalJudgmentEffect();
                } else {
                    createExplosion(enemy);
                }
            }, 150);
        }
        
        // åˆ›å»ºæ”¿ç­–åˆ¶å®šæ•ˆæœ
        function createPolicyMakingEffect() {
            const battlefield = document.querySelector('.battlefield');
            const enemyRect = enemy.getBoundingClientRect();
            const battlefieldRect = battlefield.getBoundingClientRect();
            
            // åˆ›å»ºæ”¿ç­–æ–‡ä»¶
            const policies = ['CSPè®¤è¯', 'NOIæ”¹é©', 'ç®—æ³•æ ‡å‡†', 'ç«èµ›è§„åˆ™'];
            
            policies.forEach((policy, index) => {
                setTimeout(() => {
                    const policyElement = document.createElement('div');
                    policyElement.style.position = 'absolute';
                    policyElement.style.background = 'linear-gradient(135deg, #3B82F6 0%, #2563EB 100%)';
                    policyElement.style.color = 'white';
                    policyElement.style.padding = '10px 15px';
                    policyElement.style.borderRadius = '6px';
                    policyElement.style.fontWeight = 'bold';
                    policyElement.style.left = `${100 + index * 80}px`;
                    policyElement.style.top = `${50}px`;
                    policyElement.style.opacity = '0';
                    policyElement.style.transform = 'rotate(-10deg)';
                    policyElement.textContent = policy;
                    
                    battlefield.appendChild(policyElement);
                    
                    // åŠ¨ç”»
                    policyElement.style.transition = 'all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                    
                    setTimeout(() => {
                        policyElement.style.opacity = '1';
                        policyElement.style.top = `${100}px`;
                        
                        setTimeout(() => {
                            policyElement.style.transform = 'rotate(0deg) translateY(0)';
                            policyElement.style.left = `${enemyRect.left - battlefieldRect.left + 20}px`;
                            policyElement.style.top = `${enemyRect.top - battlefieldRect.top + 40}px`;
                            
                            setTimeout(() => {
                                policyElement.style.opacity = '0';
                                setTimeout(() => {
                                    policyElement.remove();
                                    
                                    // æœ€åä¸€ä¸ªæ”¿ç­–è§¦å‘çˆ†ç‚¸
                                    if (index === policies.length - 1) {
                                        createExplosion(enemy);
                                    }
                                }, 300);
                            }, 500);
                        }, 500);
                    }, 10);
                }, index * 200);
            });
        }
        
        // åˆ›å»ºç«èµ›åˆ¶è£æ•ˆæœ
        function createCompetitionSanctionEffect() {
            const battlefield = document.querySelector('.battlefield');
            const enemyRect = enemy.getBoundingClientRect();
            const battlefieldRect = battlefield.getBoundingClientRect();
            
            // åˆ›å»ºåˆ¶è£å…‰çº¿
            const rays = [];
            const rayCount = 6;
            
            for (let i = 0; i < rayCount; i++) {
                const ray = document.createElement('div');
                ray.style.position = 'absolute';
                ray.style.width = '6px';
                ray.style.height = '200px';
                ray.style.background = 'linear-gradient(to bottom, #10B981, transparent)';
                ray.style.left = `${50 + i * 100}px`;
                ray.style.top = '-200px';
                ray.style.opacity = '0';
                ray.style.transform = 'rotate(' + (i - 2.5) * 5 + 'deg)';
                
                battlefield.appendChild(ray);
                rays.push(ray);
            }
            
            // å…‰çº¿åŠ¨ç”»
            rays.forEach((ray, index) => {
                setTimeout(() => {
                    ray.style.transition = 'all 0.8s ease';
                    ray.style.opacity = '1';
                    ray.style.top = '400px';
                    
                    setTimeout(() => {
                        ray.style.opacity = '0';
                        setTimeout(() => {
                            ray.remove();
                        }, 300);
                    }, 600);
                }, index * 150);
            });
            
            // æœ€ç»ˆçˆ†ç‚¸
            setTimeout(() => {
                const bigExplosion = document.createElement('div');
                bigExplosion.style.position = 'absolute';
                bigExplosion.style.width = '100px';
                bigExplosion.style.height = '100px';
                bigExplosion.style.background = 'radial-gradient(circle, #10B981 0%, #059669 100%)';
                bigExplosion.style.borderRadius = '50%';
                bigExplosion.style.left = `${enemyRect.left - battlefieldRect.left - 10}px`;
                bigExplosion.style.top = `${enemyRect.top - battlefieldRect.top - 10}px`;
                bigExplosion.style.opacity = '0';
                
                battlefield.appendChild(bigExplosion);
                
                bigExplosion.style.transition = 'all 0.8s ease';
                setTimeout(() => {
                    bigExplosion.style.opacity = '1';
                    bigExplosion.style.transform = 'scale(1.5)';
                    
                    setTimeout(() => {
                        bigExplosion.style.opacity = '0';
                        setTimeout(() => {
                            bigExplosion.remove();
                        }, 300);
                    }, 500);
                }, 10);
            }, rayCount * 150 + 500);
        }
        
        // åˆ›å»ºæœ€ç»ˆè£å†³æ•ˆæœ
        function createFinalJudgmentEffect() {
            const battlefield = document.querySelector('.battlefield');
            const enemyRect = enemy.getBoundingClientRect();
            const battlefieldRect = battlefield.getBoundingClientRect();
            
            // åˆ›å»ºæœ€ç»ˆè£å†³æ ‡å¿—
            const judgment = document.createElement('div');
            judgment.style.position = 'absolute';
            judgment.style.width = '120px';
            judgment.style.height = '120px';
            judgment.style.background = 'radial-gradient(circle, #8B5CF6 0%, #7C3AED 100%)';
            judgment.style.border = '4px solid #C4B5FD';
            judgment.style.borderRadius = '50%';
            judgment.style.display = 'flex';
            judgment.style.alignItems = 'center';
            judgment.style.justifyContent = 'center';
            judgment.style.color = 'white';
            judgment.style.fontSize = '24px';
            judgment.style.fontWeight = 'bold';
            judgment.style.left = `${player.offsetLeft - 20}px`;
            judgment.style.top = `${player.offsetTop - 20}px`;
            judgment.style.opacity = '0';
            judgment.style.zIndex = '30';
            judgment.textContent = 'è£å†³';
            
            battlefield.appendChild(judgment);
            
            // åŠ¨ç”»
            judgment.style.transition = 'all 1s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            
            setTimeout(() => {
                judgment.style.opacity = '1';
                judgment.style.transform = 'scale(1.2)';
                
                setTimeout(() => {
                    judgment.style.left = `${enemyRect.left - battlefieldRect.left - 20}px`;
                    judgment.style.top = `${enemyRect.top - battlefieldRect.top - 20}px`;
                    
                    setTimeout(() => {
                        // æœ€ç»ˆçˆ†ç‚¸
                        const finalBlast = document.createElement('div');
                        finalBlast.className = 'final-blast';
                        finalBlast.style.left = `${enemyRect.left - battlefieldRect.left - 80}px`;
                        finalBlast.style.top = `${enemyRect.top - battlefieldRect.top - 80}px`;
                        
                        battlefield.appendChild(finalBlast);
                        
                        judgment.remove();
                        
                        // å…¨å±éœ‡åŠ¨æ•ˆæœ
                        document.body.style.animation = 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both';
                        setTimeout(() => {
                            document.body.style.animation = '';
                        }, 500);
                        
                        setTimeout(() => {
                            finalBlast.remove();
                        }, 1500);
                    }, 800);
                }, 500);
            }, 10);
        }
        
        // åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
        function createExplosion(target) {
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            
            const targetRect = target.getBoundingClientRect();
            const battlefieldRect = document.querySelector('.battlefield').getBoundingClientRect();
            
            explosion.style.left = `${targetRect.left - battlefieldRect.left + 30}px`;
            explosion.style.top = `${targetRect.top - battlefieldRect.top + 30}px`;
            
            document.querySelector('.battlefield').appendChild(explosion);
            
            setTimeout(() => {
                explosion.remove();
            }, 500);
        }
        
        // åˆ›å»ºä¼¤å®³æ•°å­—
        function createDamageNumber(damage, target) {
            const damageText = document.createElement('div');
            damageText.className = 'floating-text text-red-500';
            damageText.textContent = `-${damage}`;
            
            const targetRect = target.getBoundingClientRect();
            const battlefieldRect = document.querySelector('.battlefield').getBoundingClientRect();
            
            damageText.style.left = `${targetRect.left - battlefieldRect.left + 40}px`;
            damageText.style.top = `${targetRect.top - battlefieldRect.top}px`;
            
            document.querySelector('.battlefield').appendChild(damageText);
            
            setTimeout(() => {
                damageText.remove();
            }, 1000);
        }
        
        // æ•Œäººæ”»å‡»
        function enemyAttack() {
            if (gameState.isGameOver) return;
            
            // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ç‰¹æ®Šæ”»å‡»
            if (gameState.enemy.specialAttackCooldown === 0 && Math.random() < 0.3) {
                useSpecialAttack();
                return;
            }
            
            // æ’­æ”¾æ”»å‡»åŠ¨ç”»
            enemy.classList.add('animate-attack');
            setTimeout(() => {
                enemy.classList.remove('animate-attack');
            }, 300);
            
            // åˆ›å»ºæ™®é€šæ”»å‡»æ•ˆæœ
            createNormalAttack();
            
            // ç©å®¶å—å‡»åŠ¨ç”»
            setTimeout(() => {
                player.classList.add('animate-hit');
                setTimeout(() => {
                    player.classList.remove('animate-hit');
                }, 300);
                
                // åˆ›å»ºä¼¤å®³æ•°å­—
                createDamageNumber(gameState.enemy.damage, player);
            }, 500);
            
            // æ‰£é™¤ç©å®¶ç”Ÿå‘½å€¼
            gameState.player.health = Math.max(0, gameState.player.health - gameState.enemy.damage);
            
            // æ·»åŠ æˆ˜æ–—æ—¥å¿—
            addBattleLog(`${enemyName.textContent} æ”»å‡»é€ æˆ ${gameState.enemy.damage} ç‚¹ä¼¤å®³`);
            
            // æ›´æ–°UI
            updatePlayerUI();
            
            // æ£€æŸ¥ç©å®¶æ˜¯å¦æ­»äº¡
            if (gameState.player.health <= 0) {
                endGame(false);
                return;
            }
            
            // åˆ‡æ¢å›åˆ
            gameState.isPlayerTurn = true;
        }
        
        // ä½¿ç”¨ç‰¹æ®Šæ”»å‡»
        function useSpecialAttack() {
            const attacks = ['timeFreeze', 'ultimateExplosion'];
            const attack = attacks[Math.floor(Math.random() * attacks.length)];
            
            switch (attack) {
                case 'timeFreeze':
                    timeFreezeAttack();
                    break;
                case 'ultimateExplosion':
                    ultimateExplosionAttack();
                    break;
            }
            
            // è®¾ç½®ç‰¹æ®Šæ”»å‡»å†·å´
            gameState.enemy.specialAttackCooldown = 15;
        }
        
        // æ—¶ç©ºå†»ç»“æ”»å‡»
        function timeFreezeAttack() {
            addBattleLog('ç¼–ç¨‹ä¹‹ç¥ä½¿ç”¨äº†æ—¶ç©ºå†»ç»“ï¼', 'error');
            
            // å†»ç»“æ•ˆæœ
            gameState.isFrozen = true;
            document.body.style.filter = 'grayscale(0.7) blur(1px)';
            
            // æ‰£é™¤ç”Ÿå‘½å€¼
            const freezeDamage = 60;
            gameState.player.health = Math.max(0, gameState.player.health - freezeDamage);
            
            addBattleLog(`æ—¶ç©ºå†»ç»“é€ æˆ ${freezeDamage} ç‚¹ä¼¤å®³ï¼Œä½ è¢«å†»ç»“3ç§’ï¼`, 'error');
            
            // æ›´æ–°UI
            updatePlayerUI();
            
            // æ£€æŸ¥ç©å®¶æ˜¯å¦æ­»äº¡
            if (gameState.player.health <= 0) {
                endGame(false);
                return;
            }
            
            // 3ç§’åè‡ªåŠ¨åˆ‡æ¢å›åˆ
            setTimeout(() => {
                if (!gameState.isGameOver) {
                    gameState.isPlayerTurn = true;
                }
            }, 3000);
        }
        
        // ç»ˆæçˆ†ç‚¸æ”»å‡»
        function ultimateExplosionAttack() {
            addBattleLog('ç¼–ç¨‹ä¹‹ç¥å‡†å¤‡ä½¿ç”¨ç»ˆæçˆ†ç‚¸ï¼', 'error');
            
            const battlefield = document.querySelector('.battlefield');
            
            // åˆ›å»ºè­¦å‘Šæ•ˆæœ
            const warning = document.createElement('div');
            warning.style.position = 'absolute';
            warning.style.width = '200px';
            warning.style.height = '200px';
            warning.style.border = '4px dashed #EF4444';
            warning.style.borderRadius = '50%';
            warning.style.left = `${player.offsetLeft - 60}px`;
            warning.style.top = `${player.offsetTop - 60}px`;
            warning.style.animation = 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite';
            warning.style.zIndex = '20';
            
            battlefield.appendChild(warning);
            
            // 2ç§’åçˆ†ç‚¸
            setTimeout(() => {
                warning.remove();
                
                const explosion = document.createElement('div');
                explosion.className = 'final-blast';
                explosion.style.left = `${player.offsetLeft - 80}px`;
                explosion.style.top = `${player.offsetTop - 80}px`;
                
                battlefield.appendChild(explosion);
                
                // é€ æˆä¼¤å®³
                const explosionDamage = 80;
                gameState.player.health = Math.max(0, gameState.player.health - explosionDamage);
                
                addBattleLog(`ç»ˆæçˆ†ç‚¸é€ æˆ ${explosionDamage} ç‚¹ä¼¤å®³ï¼`, 'error');
                
                // æ›´æ–°UI
                updatePlayerUI();
                
                // å…¨å±éœ‡åŠ¨æ•ˆæœ
                document.body.style.animation = 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both';
                setTimeout(() => {
                    document.body.style.animation = '';
                }, 500);
                
                // æ£€æŸ¥ç©å®¶æ˜¯å¦æ­»äº¡
                if (gameState.player.health <= 0) {
                    endGame(false);
                    return;
                }
                
                // åˆ‡æ¢å›åˆ
                gameState.isPlayerTurn = true;
                
                setTimeout(() => {
                    explosion.remove();
                }, 1500);
            }, 2000);
        }
        
        // åˆ›å»ºæ™®é€šæ”»å‡»æ•ˆæœ
        function createNormalAttack() {
            const battlefield = document.querySelector('.battlefield');
            const playerRect = player.getBoundingClientRect();
            const battlefieldRect = battlefield.getBoundingClientRect();
            
            // åˆ›å»ºç¼–ç¨‹ç¬¦å·æ”»å‡»
            const symbols = ['Î»', 'âˆ‘', 'âˆ†', 'Î©', 'Î '];
            
            symbols.forEach((symbol, index) => {
                setTimeout(() => {
                    const symbolElement = document.createElement('div');
                    symbolElement.style.position = 'absolute';
                    symbolElement.style.background = 'linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)';
                    symbolElement.style.color = 'white';
                    symbolElement.style.width = '40px';
                    symbolElement.style.height = '40px';
                    symbolElement.style.borderRadius = '50%';
                    symbolElement.style.display = 'flex';
                    symbolElement.style.alignItems = 'center';
                    symbolElement.style.justifyContent = 'center';
                    symbolElement.style.fontSize = '20px';
                    symbolElement.style.fontWeight = 'bold';
                    symbolElement.style.right = '100px';
                    symbolElement.style.top = `${100 + index * 50}px`;
                    symbolElement.style.opacity = '0';
                    symbolElement.textContent = symbol;
                    
                    battlefield.appendChild(symbolElement);
                    
                    // åŠ¨ç”»
                    symbolElement.style.transition = 'all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                    
                    setTimeout(() => {
                        symbolElement.style.opacity = '1';
                        symbolElement.style.right = `${playerRect.left - battlefieldRect.left + 100}px`;
                        
                        setTimeout(() => {
                            symbolElement.style.opacity = '0';
                            setTimeout(() => {
                                symbolElement.remove();
                            }, 300);
                        }, 400);
                    }, 10);
                }, index * 100);
            });
        }
        
        // æ›´æ–°ç©å®¶UI
        function updatePlayerUI() {
            playerHealthBar.style.width = `${(gameState.player.health / gameState.player.maxHealth) * 100}%`;
            playerHealthText.textContent = `${gameState.player.health}/${gameState.player.maxHealth}`;
            
            playerEnergyBar.style.width = `${(gameState.player.energy / gameState.player.maxEnergy) * 100}%`;
            playerEnergyText.textContent = `${Math.floor(gameState.player.energy)}/${gameState.player.maxEnergy}`;
            
            // æ›´æ–°æŠ€èƒ½æŒ‰é’®çŠ¶æ€
            updateSkillButtons();
        }
        
        // æ›´æ–°æ•ŒäººUI
        function updateEnemyUI() {
            enemyHealthBar.style.width = `${(gameState.enemy.health / gameState.enemy.maxHealth) * 100}%`;
            enemyHealthText.textContent = `${gameState.enemy.health}/${gameState.enemy.maxHealth}`;
        }
        
        // æ›´æ–°æŠ€èƒ½æŒ‰é’®
        function updateSkillButtons() {
            const skillButtons = document.querySelectorAll('.skill-button');
            
            skillButtons.forEach(button => {
                const skillType = button.dataset.skill;
                const skill = gameState.player.skills[skillType];
                const cooldown = gameState.player.currentCooldowns[skillType] || 0;
                
                // ç§»é™¤ä¹‹å‰çš„å†·å´è¦†ç›–å±‚
                const existingOverlay = button.querySelector('.cooldown-overlay');
                if (existingOverlay) existingOverlay.remove();
                
                // æ£€æŸ¥èƒ½é‡å’Œå†·å´
                if (gameState.player.energy < skill.energy || cooldown > 0 || gameState.isFrozen) {
                    button.classList.add('disabled');
                    
                    // æ·»åŠ å†·å´è¦†ç›–å±‚
                    const overlay = document.createElement('div');
                    overlay.className = 'cooldown-overlay absolute inset-0 flex items-center justify-center rounded-lg';
                    
                    if (gameState.isFrozen) {
                        overlay.textContent = 'å†»ç»“';
                    } else {
                        overlay.textContent = cooldown > 0 ? cooldown : 'èƒ½é‡ä¸è¶³';
                    }
                    
                    button.style.position = 'relative';
                    button.appendChild(overlay);
                } else {
                    button.classList.remove('disabled');
                }
            });
        }
        
        // æ›´æ–°å†·å´
        function updateCooldowns() {
            for (const skillType in gameState.player.currentCooldowns) {
                if (gameState.player.currentCooldowns[skillType] > 0) {
                    gameState.player.currentCooldowns[skillType]--;
                }
            }
            
            updatePlayerUI();
        }
        
        // æ·»åŠ æˆ˜æ–—æ—¥å¿—
        function addBattleLog(message, type = 'normal') {
            const logEntry = document.createElement('div');
            
            switch (type) {
                case 'critical':
                    logEntry.className = 'text-yellow-400 font-bold';
                    break;
                case 'warning':
                    logEntry.className = 'text-orange-400';
                    break;
                case 'error':
                    logEntry.className = 'text-red-400 font-bold';
                    break;
                case 'success':
                    logEntry.className = 'text-green-400';
                    break;
                default:
                    logEntry.className = 'text-gray-300';
            }
            
            logEntry.textContent = `[${formatTime(gameState.countdown)}] ${message}`;
            battleLog.appendChild(logEntry);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            battleLog.scrollTop = battleLog.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (battleLog.children.length > 20) {
                battleLog.removeChild(battleLog.firstChild);
            }
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // ç»“æŸæ¸¸æˆ
        function endGame(isVictory) {
            gameState.isGameOver = true;
            
            if (isVictory) {
                // èƒœåˆ©åŠ¨ç”»
                player.classList.add('animate-victory');
                enemy.style.opacity = '0.5';
                enemy.style.transform = 'rotate(90deg) scale(0.8)';
                presidentAura.style.opacity = '0';
                
                addBattleLog('æ­å–œï¼ä½ å‡»è´¥äº†ç¼–ç¨‹ä¹‹ç¥ï¼', 'success');
                addBattleLog('ä½ å·²ç»æˆä¸ºäº†çœŸæ­£çš„ç¼–ç¨‹å¤§å¸ˆï¼', 'success');
                
                // ä¿å­˜è¿›åº¦
                const userData = JSON.parse(localStorage.getItem('fightCCFUser')) || { unlockedLevels: [], unlockedCharacters: [] };
                if (!userData.unlockedLevels.includes(6)) {
                    userData.unlockedLevels.push(6);
                }
                if (!userData.unlockedCharacters.includes(6)) {
                    userData.unlockedCharacters.push(6);
                }
                userData.isCompleted = true;
                localStorage.setItem('fightCCFUser', JSON.stringify(userData));
                
                // æ˜¾ç¤ºæœ€ç»ˆèƒœåˆ©æ¨¡æ€æ¡†
                setTimeout(() => {
                    finalVictoryModal.classList.remove('hidden');
                }, 2000);
                
            } else {
                // å¤±è´¥åŠ¨ç”»
                player.classList.add('animate-defeat');
                player.style.opacity = '0.5';
                
                resultIcon.className = 'text-6xl mb-4 text-red-500';
                resultIcon.innerHTML = '<i class="fa fa-times-circle"></i>';
                resultTitle.textContent = 'æˆ˜æ–—å¤±è´¥';
                resultMessage.textContent = 'ç¼–ç¨‹ä¹‹ç¥çš„åŠ›é‡è¿‡äºå¼ºå¤§...ä½†ä¸è¦æ”¾å¼ƒï¼Œç»§ç»­åŠªåŠ›ï¼';
                
                addBattleLog('æˆ˜æ–—å¤±è´¥ï¼', 'error');
                
                // æ˜¾ç¤ºç»“æœæ¨¡æ€æ¡†
                setTimeout(() => {
                    resultModal.classList.remove('hidden');
                }, 1000);
            }
        }
        
        // ç¦ç”¨å³é”®å’ŒCtrlé”®
        function disableRightClickAndCtrl() {
            document.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                return false;
            });
            
            document.addEventListener('keydown', (e) => {
                // ç¦ç”¨Ctrl+S, Ctrl+C, Ctrl+Vç­‰
                if (e.ctrlKey) {
                    e.preventDefault();
                    return false;
                }
                
                // ç¦ç”¨F12, F5ç­‰
                if ([123, 116, 115, 119, 122].includes(e.keyCode)) {
                    e.preventDefault();
                    return false;
                }
            });
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('keydown', (e) => {
            if (gameState.isGameOver || gameState.isFrozen) return;
            
            switch (e.key.toLowerCase()) {
                case 'w':
                    movePlayer('up');
                    break;
                case 's':
                    movePlayer('down');
                    break;
                case 'a':
                    movePlayer('left');
                    break;
                case 'd':
                    movePlayer('right');
                    break;
                case 'i':
                    if (gameState.isPlayerTurn) {
                        playerAttack('normal');
                    }
                    break;
                case 'j':
                    if (gameState.isPlayerTurn) {
                        playerAttack('skill1');
                    }
                    break;
                case 'k':
                    if (gameState.isPlayerTurn) {
                        playerAttack('skill2');
                    }
                    break;
                case 'l':
                    if (gameState.isPlayerTurn) {
                        playerAttack('skill3');
                    }
                    break;
            }
        });
        
        // æŠ€èƒ½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.skill-button').forEach(button => {
            button.addEventListener('click', () => {
                if (gameState.isGameOver || !gameState.isPlayerTurn || gameState.isFrozen) return;
                
                const skillType = button.dataset.skill;
                playerAttack(skillType);
            });
        });
        
        // ç»“æœæ¨¡æ€æ¡†æŒ‰é’®äº‹ä»¶
        restartBtn.addEventListener('click', () => {
            // é‡æ–°å¼€å§‹å½“å‰å…³å¡
            location.reload();
        });
        
        homeBtn.addEventListener('click', () => {
            // è¿”å›ä¸»é¡µ
            window.location.href = 'index.html';
        });
        
        backBtn.addEventListener('click', () => {
            // è¿”å›ä¸»é¡µ
            window.location.href = 'index.html';
        });
        
        playAgainBtn.addEventListener('click', () => {
            // é‡ç½®æ¸¸æˆè¿›åº¦å¹¶è¿”å›ä¸»é¡µ
            const userData = JSON.parse(localStorage.getItem('fightCCFUser')) || {};
            userData.isCompleted = false;
            userData.unlockedLevels = [1];
            userData.unlockedCharacters = [1];
            localStorage.setItem('fightCCFUser', JSON.stringify(userData));
            
            window.location.href = 'index.html';
        });
        
        // çª—å£å¤§å°æ”¹å˜æ—¶æ›´æ–°å…‰ç¯ä½ç½®
        window.addEventListener('resize', updatePresidentAura);
    </script>
</body>
</html>
