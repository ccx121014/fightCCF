<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>fightCCF - 登录</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="login-container">
        <h1 class="login-title">fightCCF</h1>
        <div>
            <h2>创建账号</h2>
            <form id="create-form" class="login-form">
                <input type="text" id="create-username" class="login-input" placeholder="输入用户名" required>
                <button type="submit" class="login-button">创建账号</button>
            </form>
            
            <h2>登录</h2>
            <form id="login-form" class="login-form">
                <input type="text" id="login-key" class="login-input" placeholder="输入秘钥" required>
                <button type="submit" class="login-button">登录</button>
            </form>
        </div>
    </div>
    <script>
        // 全局变量
        let currentUser = null;
        let gameState = {
            levels: {
                'chapter1': [true, false, false, false, false],
                'chapter2': [false, false, false, false, false],
                'chapter3': [false, false, false, false, false],
                'chapter4': [false, false, false, false, false],
                'chapter5': [false, false, false, false, false],
                'chapter6': [false, false, false, false, false]
            },
            characters: [
                { id: 'c1', name: '程序员', unlocked: false, image: 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/a5469c415b534e79a33fb60d65e65fef~tplv-a9rns2rl98-image.image?rcl=202512201240470875B743E140E9E6F54C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1768797662&x-signature=osqBA%2F5y5fpxtTGjJ6Uau8JmKWo%3D', description: '擅长编程的火柴人', skills: ['快速编码', '调试修复', '算法攻击'] },
                { id: 'c2', name: '黑客', unlocked: false, image: 'https://p9-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/89e01bdf9a384a358f1a5a4d78b9f155~tplv-a9rns2rl98-image.image?rcl=202512201240470875B743E140E9E6F54C&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1768797673&x-signature=bkbSA8R%2FgiUq8RmmajdVXltux6g%3D', description: '精通网络攻击的火柴人', skills: ['病毒注入', '数据窃取', '后门植入'] },
                { id: 'c3', name: '算法大师', unlocked: false, image: '', description: '掌握高级算法的火柴人', skills: ['动态规划', '图论攻击', '数据结构'] },
                { id: 'c4', name: '系统架构师', unlocked: false, image: '', description: '构建系统的火柴人', skills: ['分布式攻击', '负载均衡', '容错机制'] },
                { id: 'c5', name: 'AI专家', unlocked: false, image: '', description: '人工智能专家火柴人', skills: ['机器学习', '神经网络', '深度学习'] },
                { id: 'c6', name: 'CCF主席', unlocked: false, image: '', description: '终极BOSS', skills: ['政策制定', '标准审核', '权威判决'] }
            ],
            currentCharacter: null
        };

        // 辅助加密函数
        function generateHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(16);
        }

        function reverseString(str) {
            return str.split('').reverse().join('');
        }

        // 账号系统
        function createAccount(username) {
            console.log('Creating account for:', username);
            // 解锁第一章角色
            const newGameState = JSON.parse(JSON.stringify(gameState));
            newGameState.characters[0].unlocked = true;
            newGameState.currentCharacter = 'c1';
            
            const userData = {
                username: username,
                gameState: newGameState,
                createdAt: new Date().toISOString(),
                version: '1.0',
                hash: generateHash(username + Date.now())
            };
            
            console.log('UserData:', userData);
            
            // 多层加密
            let secretKey = JSON.stringify(userData);
            secretKey = btoa(secretKey);
            secretKey = reverseString(secretKey);
            secretKey = btoa(secretKey);
            
            console.log('Generated secret key:', secretKey);
            
            localStorage.setItem('currentUser', JSON.stringify({ username, secretKey }));
            currentUser = { username, secretKey };
            return secretKey;
        }

        function loginWithKey(secretKey) {
            console.log('Login with key:', secretKey);
            try {
                // 多层解密
                let decrypted = atob(secretKey);
                decrypted = reverseString(decrypted);
                decrypted = atob(decrypted);
                
                const userData = JSON.parse(decrypted);
                console.log('Decrypted user data:', userData);
                
                if (userData.username && userData.gameState) {
                    localStorage.setItem('currentUser', JSON.stringify({ username: userData.username, secretKey }));
                    currentUser = { username: userData.username, secretKey };
                    gameState = userData.gameState;
                    return true;
                }
                return false;
            } catch (e) {
                console.error('Login error:', e);
                return false;
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Login page loaded');
            
            const createForm = document.getElementById('create-form');
            const loginForm = document.getElementById('login-form');
            
            console.log('Create form element:', createForm);
            console.log('Login form element:', loginForm);
            
            if (createForm) {
                createForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    console.log('Create form submitted');
                    const username = document.getElementById('create-username').value;
                    console.log('Username:', username);
                    if (username) {
                        try {
                            const secretKey = createAccount(username);
                            alert(`账号创建成功！秘钥：${secretKey}`);
                            window.location.href = 'index.html';
                        } catch (error) {
                            console.error('Create account error:', error);
                            alert('创建账号时出错：' + error.message);
                        }
                    }
                });
            }
            
            if (loginForm) {
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    console.log('Login form submitted');
                    const secretKey = document.getElementById('login-key').value;
                    console.log('Secret key:', secretKey);
                    if (secretKey) {
                        try {
                            if (loginWithKey(secretKey)) {
                                alert('登录成功！');
                                window.location.href = 'index.html';
                            } else {
                                alert('无效的秘钥！');
                            }
                        } catch (error) {
                            console.error('Login error:', error);
                            alert('登录时出错：' + error.message);
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
